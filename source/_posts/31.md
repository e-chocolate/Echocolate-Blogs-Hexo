---
title: Gitea 服务端部署
date: 2023-02-14 12:12:00
---

　　[Gitea](https://about.gitea.com/)可以在我们的VPS中构建一个Git服务端，相当于一个袖珍版的"Github"，在自己的服务器中管理我们的代码。将我们的代码同步到不同的远程仓库中，也降低了我们代码丢失的机率。

# 准备数据库
## 创建名为'giteadb'的数据库及用户'gitea'
```mysql
CREATE DATABASE giteadb CHARACTER SET 'utf8mb4' COLLATE 'utf8mb4_unicode_ci';

CREATE USER 'gitea'@'localhost' IDENTIFIED BY 'gitea';
CREATE USER 'gitea'@'127.0.0.1' IDENTIFIED BY 'gitea';

GRANT ALL PRIVILEGES ON giteadb.* TO 'gitea'@'localhost';
GRANT ALL PRIVILEGES ON giteadb.* TO 'gitea'@'127.0.0.1';
FLUSH PRIVILEGES;
```

> 数据库创建好之后，可以先测试一下数据库连接是否正常

# 安装 gitea
```shell
wget -O gitea https://dl.gitea.com/gitea/1.21.1/gitea-1.21.1-linux-amd64
chmod +x gitea
mv gitea /usr/local/bin/gitea

adduser --system --shell /bin/bash --gecos 'Git Version Control' --group --disabled-password --home /home/git git

mkdir -p /var/lib/gitea/{custom,data,log}
chown -R git:git /var/lib/gitea/ && chmod -R 750 /var/lib/gitea/
mkdir /etc/gitea
chown root:git /etc/gitea && chmod 770 /etc/gitea
```

# 准备配置文件
1. 首先下载[官方参考文件](https://github.com/go-gitea/gitea/blob/release/v1.21/custom/conf/app.example.ini)
2. 将配置文件移动到`/etc/gitea/app.ini`(位置随意)
3. 按需修改配置文件，主要修改`database`相关
```ini
[database]
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; MySQL Configuration
;;
DB_TYPE = mysql
HOST = 127.0.0.1:3306 ; can use socket e.g. /var/run/mysqld/mysqld.sock
NAME = giteadb
USER = gitea
PASSWD = `password`
```

> 如果自己确定配置文件没问题，不需要 gitea 修改其他配置，可以设置配置文件只读
> ```shell
> chown root:git /etc/gitea/app.ini && chmod 640 /etc/gitea/app.ini
> ```

# 设置自启动
[官方自启动配置示例](https://github.com/go-gitea/gitea/blob/release/v1.21/contrib/systemd/gitea.service)

```
[Unit]
Description=Gitea (Git with a cup of tea)
After=network.target

[Service]
RestartSec=2s
Type=simple
User=git
Group=git
WorkingDirectory=/var/lib/gitea/
ExecStart=/usr/local/bin/gitea web --config /etc/gitea/app.ini
Restart=always
Environment=USER=git HOME=/home/git GITEA_WORK_DIR=/var/lib/gitea

[Install]
WantedBy=multi-user.target
```

最后通过`sudo systemctl enable --now gitea`开启 gitea 并自启动

# 配置 Nginx 反向代理
在`server`块中添加
```conf
location / {
    client_max_body_size 512M;
    proxy_pass http://localhost:3000;
    proxy_set_header Connection $http_connection;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

> 参考文献：
> - [官方安装手册](https://docs.gitea.cn/category/installation)
> - [SMTP server does not support AUTH](https://github.com/go-gitea/gitea/issues/28383)
> - [Email could not initiate SMTP session error](https://forum.gitea.com/t/email-could-not-initiate-smtp-session-error/8164/1)