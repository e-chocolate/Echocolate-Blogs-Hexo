---
title: MySQL 配置主从复制
date: 2022-12-24 20:00:00
---

MySQL主从复制是常见的进行MySQL数据备份的方式，记录一下主从配置的过程。

整体步骤为：
1. 主库开启`binlog`，并设置需要需要同步的数据库
2. 主库创建允许进行主从复制的用户
3. 在从库设置主库的相关信息
4. 在从库开启同步操作，并查看主从复制的状态

> 注意：如果主库已经存在数据，需要先将主库的数据先完全导入到从库中，或者在配置主从复制时，就忽略这些已经存在的数据库

主从复制依赖 binlog，因此需要在主库开启 binlog。

# 设置需要同步的数据库
## 主库配置示例
```ini
[mysqld]
log-bin=mysql-bin
binlog_format=mixed

# mysql服务ID，保证整个集群环境中唯一
server-id = 1
max_binlog_size = 100M

# 忽略同步的数据库
binlog-ignore-db=information_schema
binlog-ignore-db=mysql
binlog-ignore-db=performance_schema
binlog-ignore-db=sys

# 是否只读，1代表只读，0代表读写
read-only=0
```

> 注意：`binlog_do_db` 与 `binlog_ignore_db` 这两个参数为互斥关系，一般只选择其一设置。
> ```ini
> # 此参数表示只记录指定数据库的二进制日志，默认全部记录
> binlog-do-db=db01
> 
> # 此参数表示不记录指定的数据库的二进制日志
> binlog-ignore-db=mysql
> ```

## 从库配置示例
```ini
# mysql服务ID，保证整个集群环境中唯一，取值范围1~2^32-1，和主库不一样即可
server-id=2

# 是否只读，1代表只读，0代表读写
read-only=1

# 超级管理员是否只读，1代表只读，0代表读写
super-read-only=1
```

# 创建进行主从复制的用户
```sql
# 创建主从复制的用户，该用户可在任意主机连接该MySQL服务
CREATE USER 'slaveHost'@'%' IDENTIFIED WITH mysql_native_password BY 'HostSlaveClient';

# 为该用户分配主从复制权限
GRANT REPLICATION SLAVE ON *.* TO 'slaveHost'@'%';
flush privileges;
```

> 注意：也可以使用简写形式
> ```sql
> GRANT REPLICATION SLAVE ON *.* to 'slaveHost'@'%' identified by 'HostSlaveClient'; 
> flush privileges;
> ```

# 在从库设置主库的相关信息
## 查看当地的主库信息
```shell
mysql> show master status;
+------------------+----------+--------------+------------------------------------------------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB                                           | Executed_Gtid_Set |
+------------------+----------+--------------+------------------------------------------------------------+-------------------+
| mysql-bin.000005 |      154 |              | information_schema,mysql,performance_schema,phpmyadmin,sys |                   |
+------------------+----------+--------------+------------------------------------------------------------+-------------------+
1 row in set (0.33 sec)
```

## 在从库配置主库相关信息
```sql
CHANGE MASTER TO
    MASTER_HOST='xx.xx.xx.xx',
    MASTER_PORT=3306,
    MASTER_USER='slaveHost',
    MASTER_PASSWORD='HostSlaveClient',
    MASTER_LOG_FILE='mysql-bin.000005',
    MASTER_LOG_POS=154
;
```
> 注意：
1. 在主库查看信息之后，应该暂停操作主库。
2. 自MySLQ 8.0.23之后，在从库配置主库的相关语法改为如下
```sql
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST='xxx.xxx.xxx.xxx',
  SOURCE_PORT=3306,
  SOURCE_USER='slaveHost',
  SOURCE_PASSWORD='password',
  SOURCE_LOG_FiLE='mysql-bin.000005',
  SOURCE_LOG_POS=154
;
```

# 从库开启同步操作，并查看主从复制的状态
```sql
# 开启同步操作
start slave;

# 查看主从同步状态
show slave status;
show slave status\G
```

> 注意：自MySLQ 8.0.23之后，从库开启主从同步的相关语法改为如下
```sql
# 开启同步操作
start replica;

# 查看主从同步状态
show replica status;
```

> 参考文献：
> - [主库存在数据时，主从复制](https://zhuanlan.zhihu.com/p/100863091)